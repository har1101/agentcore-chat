# Bedrock AgentCore用Streamlitアプリ

このStreamlitアプリケーションは、デプロイ済みのBedrock AgentCoreエージェントと対話するための高度なチャットインターフェースを提供し、リアルタイムのツール使用状況の可視化とデバッグ機能を備えています。

## 前提条件

1. AgentCoreランタイムを呼び出す権限を持つAWS認証情報が設定されていること
2. Python 3.8以上
3. MCPツールサポートを有効にしてAgentCoreエージェントがデプロイされていること

## インストール

1. 必要な依存関係をインストール:
```bash
pip install -r streamlit_requirements.txt
```

## アプリケーションの実行

1. Streamlitアプリを実行:
```bash
streamlit run streamlit_app.py
```

2. ブラウザでアプリが開きます（通常は http://localhost:8501）

## 機能

### コア機能
- **チャットインターフェース**: AgentCoreエージェントと通信するインタラクティブなチャットインターフェース
- **セッション管理**: 複数のやり取りにわたって会話コンテキストを維持
- **ストリーミングレスポンス**: 改善されたパーシングによるエージェントレスポンスのリアルタイムストリーミング
- **セッションリセット**: 新しい会話セッションを開始する機能

### 新しい高度な機能
- **ツール使用状況の可視化** 🔧: エージェントがMCPツールを使用したときのリアルタイム表示
- **AWS Knowledge統合**: AWS Documentation MCPツールが使用されたときの視覚的インジケーター
- **デバッグモード**: トラブルシューティング用の生イベントデータの開発者向けビュー
- **設定可能な表示**: ツール使用状況とデバッグ情報のオン/オフ切り替え
- **改善されたツール検出**: message.content配列内のtoolUseオブジェクトを適切に処理

### UIの強化
- **サイドバーコントロール**: 包括的なセッションと表示設定
- **ツール使用通知**: 使用されているツールを示すインフォボックス
- **エラーハンドリング**: より良いエラー表示とユーザーフィードバック
- **デバッグ情報**: 技術的詳細のための展開可能なセクション
- **生レスポンス分析**: レスポンス形式を理解するための詳細な分析ビュー

## 設定

アプリは自動的にデプロイ済みのエージェントに接続します。手動のARN設定は不要です。

接続設定を変更するには、`streamlit_app.py`内の設定変数を編集してください。

## 動作の仕組み

### 基本フロー
1. アプリはAWS SDK（boto3）を使用してBedrock AgentCoreサービスに接続
2. メッセージを送信すると、プロンプトを含むJSONペイロードを作成
3. アプリはエージェントのARNを使用して`InvokeAgentRuntime` APIを呼び出し
4. レスポンスがストリーミングされ、リアルタイムで表示
5. セッションIDを使用して会話コンテキストを維持

### 高度な処理
6. **イベント分類**: レスポンスイベントを`text`、`tool_use`、または`error`として分類
7. **ツール検出**: 様々なMCPツール形式に対する複数の検出方法
8. **リアルタイム更新**: ツールが呼び出されるとすぐにツール使用情報が表示
9. **デバッグログ**: 開発用の詳細なイベント情報（オプション）

## ツール使用検出

アプリは以下の使用を検出して表示します：

- **AWS Knowledge MCPツール**: AWSドキュメントを検索する際
  - 🔍 AWS Documentation Search
  - 📖 AWS Documentation Reader
  - 💡 AWS Documentation Recommendations
- **カスタムMCPツール**: エージェントと統合されたMCPベースのツール
- **Strandsフレームワークツール**: Strandsエコシステムの組み込みツール

### 検出方法
- イベントタイプ分析（`tool_use`、`tool_call`）
- レスポンスストリームからのツールメタデータ抽出
- AWS固有のパターンマッチング
- MCPプロトコルイベントのパーシング
- message.content配列内のtoolUseオブジェクトの検出

## 表示設定

### ツール使用状況表示
- **ツール使用状況を表示**: ツール使用通知の表示/非表示切り替え
- エージェントの機能に関するリアルタイムフィードバックを提供
- エージェントの意思決定プロセスの理解を支援

### デバッグモード
- **デバッグ情報を表示**: 開発とトラブルシューティング用に有効化
- 展開可能なセクションに生イベントデータを表示
- パフォーマンスのため最後の5つのデバッグイベントを表示
- レスポンス構造の理解に有用

### 生レスポンス分析
- **生レスポンス形式を表示**: 完全なレスポンス構造の詳細な分析を有効化
- 実際のイベントストリーム形式の理解に役立つ
- ツール検出の問題のデバッグに有用

## 使用例

### 基本的なチャット
```
ユーザー: 「こんにちは、元気ですか？」
エージェント: 「こんにちは！元気です、聞いてくれてありがとう...」
```

### ツール使用例
```
ユーザー: 「AWS Lambdaとは何ですか？」
🔍 AWS Documentation Search
エージェント: 「AWS Lambdaはサーバーレスコンピューティングサービスです...」
```

### デバッグ情報
デバッグモードが有効な場合、以下のような技術的詳細が表示されます：
```json
Type: tool_use, Data: 🔍 AWS Documentation Search
Type: text, Data: AWS Lambdaはサーバーレス...
```

## トラブルシューティング

### よくある問題

1. **認証エラー**: AWS認証情報が正しく設定されていることを確認
2. **権限エラー**: IAMロールに`bedrock-agentcore:InvokeAgentRuntime`権限があることを確認
3. **接続エラー**: エージェントがデプロイされ、アクセス可能であることを確認
4. **ツール検出の問題**: デバッグモードまたは生レスポンス分析を有効にして生イベントデータを確認

### デバッグモードの使用

1. サイドバーで「デバッグ情報を表示」を有効化
2. ツールを使用するはずのメッセージを送信
3. イベント構造のデバッグ情報を確認
4. 生データでツール使用パターンを検証

### 生レスポンス分析の使用

1. サイドバーで「生レスポンス形式を表示」を有効化
2. メッセージを送信すると、詳細なレスポンス構造が表示
3. toolUseオブジェクトがmessage.content配列内でどのように表示されるかを確認
4. この情報を使用してツール検出の問題をデバッグ

### パフォーマンスの考慮事項

- ツール使用検出は最小限のオーバーヘッドを追加
- デバッグモードはレスポンス表示をわずかに遅くする可能性
- セッション状態はインタラクション間で効率的に維持

## 高度な設定

### カスタムツール検出
カスタムツールの検出を追加するには、`streamlit_app.py`のツール検出ロジックを変更：

```python
# invoke_agent関数にカスタムパターンを追加
elif 'your_custom_tool' in str(data).lower():
    yield ('tool_use', "🔧 カスタムツールを使用")
```

### レスポンス処理
アプリはより良い分類のためにタプルベースのレスポンス処理を使用：
- `('text', content)`: 通常のテキストコンテンツ
- `('tool_use', tool_info)`: ツール使用情報
- `('error', error_message)`: エラー条件

## 技術的詳細

### イベントストリーム処理
アプリはAgentCoreの`text/event-stream`レスポンスを以下で処理：
- 構造化イベントのJSONパーシング
- ツール検出のパターンマッチング
- エラー耐性のあるフォールバックメカニズム
- リアルタイム更新機能
- message.content配列内のtoolUseオブジェクトの適切な処理

### 状態管理
- セッション状態が会話履歴を維持
- ツール使用設定はページリロード間で永続化
- デバッグ設定はセッション固有

### 最新の改善点（2025年版）

#### 折りたたみ式トレース表示の実装
- **Bedrock Agent Runtime互換UI**: 参考実装に基づく折りたたみ式expander UIの実装
- **詳細情報の整理**: ツール使用時に概要表示 + 展開可能な詳細情報
- **時系列表示の試行**: エージェント処理の流れを時系列で表示する実装（一部課題あり）

#### リアルタイム状態表示の追加
- **🚀 エージェントを起動中...**: 初期化イベント時の状態表示
- **🤔 思考中...**: メッセージ開始時の思考状態表示
- **⚙️ 内部処理を実行中...**: Strands内部処理時の状態表示
- **⏳ ツール実行中...**: 各ツール実行時のプログレス表示
- **✅ ツール実行完了**: ツール処理完了時の成功表示

#### AgentCoreレスポンス形式の分析と対応
- **response_format.md**: AgentCoreからのストリーミングレスポンス詳細分析
- **イベントタイプ別処理**: 
  - 初期化イベント（init_event_loop, start, start_event_loop）
  - メッセージ開始イベント（messageStart）
  - テキストストリーミング（contentBlockDelta）
  - ツール使用イベント（contentBlockStart with toolUse）
  - メタデータイベント（usage, metrics）
  - Strandsエージェント内部イベント

#### ツール検出の高度化
- **重複表示の防止**: 同一ツールIDによる重複検出と表示防止
- **AWS MCPツール識別**: 
  - 🔍 aws___search_documentation → AWS Documentation検索
  - 📖 aws___read_documentation → AWS Documentation読み込み
  - 💡 aws___recommend → AWS Documentation推奨
- **toolUse オブジェクトの正確な処理**: message.content配列内の構造化データ

#### UI/UX の改善
- **画面硬直時間の短縮**: 処理状況のリアルタイム表示による待機時間の体感向上
- **視覚的フィードバック**: 各処理段階での適切なアイコンと説明
- **エラーハンドリング**: より詳細なエラー情報とデバッグ支援

#### パフォーマンス最適化
- **効率的な文字列結合**: contentBlockDeltaイベントの頻繁な更新に対応
- **イベント分類**: 不要なイベント処理の削減
- **メタデータ表示**: トークン使用量とレイテンシの可視化

#### 技術的詳細
```python
# AgentCoreレスポンス処理パターン
if 'event' in data and 'contentBlockStart' in data['event']:
    # ツール使用開始の検出
    start = data['event']['contentBlockStart'].get('start', {})
    if 'toolUse' in start:
        tool_info = start['toolUse']
        # ツール情報の抽出と表示

elif 'event' in data and 'contentBlockDelta' in data['event']:
    # テキストストリーミングの処理
    text = data['event']['contentBlockDelta'].get('delta', {}).get('text', '')
    if text:
        # リアルタイムテキスト更新
```

#### 既知の課題
- **時系列表示の複雑性**: メッセージ出力とトレース表示の完全な時系列統合は技術的に困難
- **Streamlitの制約**: リアルタイム更新とコンテナ再描画のバランス調整が必要
- **レスポンス形式の多様性**: AgentCoreとStrandsエージェントの異なるイベント形式への対応

#### 今後の改善方向
- 時系列表示の更なる最適化
- ツール実行結果の詳細表示
- エージェント間コラボレーションの可視化
- カスタムツールの動的検出

この強化されたインターフェースは、ユーザーフレンドリーな体験を維持しながら、AgentCoreエージェントの操作を包括的に可視化し、処理状況のリアルタイム把握を可能にします。